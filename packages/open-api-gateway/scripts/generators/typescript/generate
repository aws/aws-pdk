#!/bin/bash

set -e

working_dir=$(pwd)
script_dir="$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" &> /dev/null && pwd 2> /dev/null; )";

# Create a temporary directory
tmp_dir=$(mktemp -d -t parse-openapi-spec)
cd $tmp_dir

# Copy the parse script into the temp directory
cp -r $script_dir/* .

spec_path=''
output_path=''
package_name=''
while [[ "$#" -gt 0 ]]; do case $1 in
  --spec-path) spec_path="$2"; shift;;
  --output-path) output_path="$2"; shift;;
  --package-name) package_name="$2"; shift;;
esac; shift; done

# Install dependencies
npm install --save-dev @openapitools/openapi-generator-cli

# Run the generator
npx openapi-generator-cli generate \
  --log-to-stderr \
  --generator-name typescript-fetch \
  --skip-operation-example \
  --generate-alias-as-model \
  --minimal-update \
  --template-dir templates \
  --config config.yaml \
  --additional-properties=npmName=$package_name,typescriptThreePlus=true,useSingleParameter=true,supportsES6=true \
  --input-spec $spec_path \
  --output $output_path

# Clean up
cd $working_dir
rm -rf $tmp_dir
